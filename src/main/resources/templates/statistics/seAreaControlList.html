<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html"
      xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head th:fragment="head(title,links,scripts)">
    <meta charset="UTF-8">
    <!--<title th:replace="${title}">肿瘤早发现</title>-->
    <script src="../static/js/jquery.min.js" th:src="@{/js/jquery.min.js}" type="text/javascript"></script>
    <script src="../static/js/common.js" th:src="@{/js/common.js}" type="text/javascript"></script>

    <script src="../static/lib/miniui/miniui.js" th:src="@{/lib/miniui/miniui.js}" type="text/javascript"></script>
    <link href="../static/lib/miniui/themes/icons.css" th:href="@{/lib/miniui/themes/icons.css}" rel="stylesheet" type="text/css" />
    <link href="../static/lib/miniui/themes/default/miniui.css" th:href="@{/lib/miniui/themes/default/miniui.css}" rel="stylesheet" type="text/css" />

    <link href="../static/css/style.css" th:href="@{/css/style.css}" rel="stylesheet" type="text/css" />
    <link href="../static/css/my-mini.css" th:href="@{/css/my-mini.css}" rel="stylesheet" type="text/css" />

    <!--[if lt IE 9]>
    <script src="../js/html5shiv.min.js" th:src="@{/js/html5shiv.min.js}"></script>
    <script src="../js/respond.js" th:src="@{/js/respond.js}"></script>
    <![endif]-->
    <!--[if lte IE 11]>
    <script type="text/javascript" src="../static/js/flexie.js" th:src="@{/js/flexie.js}"></script>
    <script type="text/javascript" src="../static/js/selectivizr.js" th:src="@{/js/selectivizr.js}"></script>
    <script type="text/javascript" src="../static/js/PIE_IE678.js" th:src="@{/js/PIE_IE678.js}"></script>
    <![endif]-->
    <link href="../lib/font-awesome/css/font-awesome.min.css" th:href="@{/lib/font-awesome/css/font-awesome.min.css}" rel="stylesheet" type="text/css" />

    <meta charset="UTF-8">
    <title>社区卫生服务中心肿瘤早发现进度表(区疾控登录的场合)</title>
</head>
<body>
<div class="content pd-10" style="width:auto; overflow: hidden;">
    <div class="mini-tabs" activeIndex="0" style=" width:100%; overflow: hidden;">
        <div title="社区卫生服务中心肿瘤早发现进度表(区疾控登录的场合)">
            <div class="col-lg-12">
                <div id="formsearch" class="row mt-10">
                    <!--/*@thymesVar id="#dic" type="com.wonders.health.tumor.common.tags.DictData"*/-->
                    <!--/*@thymesVar id="#auth" type="com.wonders.health.tumor.common.tags.AuthData"*/-->
                    <input id="role" th:value="${role}" class="mini-hidden">
                    <input id="orgCode" th:value="${orgCode}" class="mini-hidden">
                    <input id="flag" th:value="${flag}" class="mini-hidden">
                    <input id="regarea" th:value="${areaCode}" class="mini-hidden">
                    <div class="mini-col-4">
                    <label class="mr-5">筛查登记机构：</label>
                        <input id="regorg" name="regorg"  class="mini-combobox" width="70%" emptyText="请选择"
                               textField="text" valueField="id" th:value="${role =='bsq' ? #auth.currUser().orgCode:''}"  th:showNullItem="${role =='bsq' ? false:true}" th:disabled="${role =='bsq' ? true:false}" />
                    </div>
                    <div class="col-sm-4 col-lg-3">初筛登记年月开始
                        <input id="csrqStart" name="beginDate" class="mini-monthpicker"
                               allowInput="true" th:value="${tjRqStart}"  style="width:115px;"  errorMode="border" onvalidation="dateValidation" >
                        -
                        <input id="csrqEnd" name="endDate" class="mini-monthpicker"
                               th:value="${#dates.format(#dates.createNow(), 'yyyy-MM')}" allowInput="false" style="width:115px;" errorMode="border" onvalidation="dateValidation">
                        <div id="search" class="my-btn my-btn-blue" onclick="onSearch()">检索</div>
                        <div class="my-btn my-btn-blue" onclick="reset()">重置</div>
                    </div>
                </div>
                <div class="col-sm-2" align="right">
                    <div class="my-btn my-btn-blue" onclick="exportData()">导出</div>
                </div>
            </div>
            <div class="col-sm-4 col-lg-3">
                <label class="mr-5">癌症种类</label>
                <input id="cancer1" type="radio" value="1" onclick="radios(this)"> 大肠癌
                <input id="cancer2" type="radio" value="2" onclick="radios(this)"> 肺癌
                <input id="cancer3" type="radio" value="3" onclick="radios(this)"> 胃癌
                <input id="cancer4" type="radio" value="4" onclick="radios(this)"> 肝癌
                <input id="cancer5" type="radio" value="5" onclick="radios(this)"> 不分类
            </div>
            <div>
                <div id="datagrid" url="../statistics/seAreaControlData" class="mini-datagrid" style=" overflow: auto;width: calc(100vw - 25px);height: auto;display: none;"
                     sizeList="[10,20,50]" pageSize="20" idField="id">
                    <div property="columns" >
                        <div field="regorg" width="300px" headerAlign="center" style="min-width:100px; width:auto;" align="center">机构名称</div>
                        <div field="num" width="150px" headerAlign="center" align="center" allowSort="false">登记人数</div>
                        <div field="summary" width="150px" headerAlign="center" align="center" allowSort="false">完成筛查人数</div>
                        <div field="regCaseNum"  width="150px" headerAlign="center" align="center" allowSort="false">筛查阳性数</div>
                        <div field="regCaseRate"  width="150px" headerAlign="center" align="center" allowSort="false">筛查阳性率</div>
                        <div field="crcCheckNum" name="crcCheckNum" width="150px" headerAlign="center" align="center" allowSort="false" >肠镜检查数</div>
                        <div field="crcCheckRate" name="crcCheckRate" width="150px" headerAlign="center" align="center" allowSort="false" >肠镜检查率</div>
                        <div field="crcLesionNum" name="crcLesionNum"width="150px" headerAlign="center" align="center" allowSort="false" >癌前期病变数</div>
                        <div field="crcLesionRate" name="crcLesionRate" width="150px" headerAlign="center" align="center" allowSort="false" >癌前期病变治疗数</div>
                        <div field="crcCaseNum" name="crcCaseNum" width="150px" headerAlign="center" align="center" allowSort="false" >大肠癌病例数</div>
                        <div field="lucCheckNum" name="lucCheckNum" width="150px" headerAlign="center" align="center" allowSort="false" >CT检查数</div>
                        <div field="lucCheckRate" name="lucCheckRate" width="150px" headerAlign="center" align="center" allowSort="false" >CT检查率</div>
                        <div field="lucCaseNum" name="lucCaseNum" width="150px" headerAlign="center" align="center" allowSort="false" >肺癌病例数</div>
                        <div field="scCheckNum" name="scCheckNum" width="150px" headerAlign="center" align="center" allowSort="false" >胃镜检查数</div>
                        <div field="scCheckRate" name="scCheckRate" width="150px" headerAlign="center" align="center" allowSort="false" >胃镜检查率</div>
                        <div field="scCaseNum" name="scCaseNum" width="150px" headerAlign="center" align="center" allowSort="false" >胃癌病例数</div>
                        <div field="licCaseNum" name="licCaseNum" width="150px" headerAlign="center" align="center" allowSort="false" >肝癌病例数</div>
                        <div field="confirmeNum" name="confirmeNum" width="150px" headerAlign="center" align="center" allowSort="false" >确诊检查数</div>
                        <div field="confirmeRate" name="confirmeRate" width="150px" headerAlign="center" align="center" allowSort="false" >确诊检查率</div>
                        <div field="confirmeCancerNum" name="confirmeCancerNum" width="150px" headerAlign="center" align="center" allowSort="false" >确诊癌病例数</div>
                        <div field="earlyDiagnosisNum" width="150px" headerAlign="center" align="center" allowSort="false">确诊早期数</div>
                        <div field="earlyDiagnosisRate" width="150px" headerAlign="center" align="center" allowSort="false">确诊早期率</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

    mini.parse();
    var grid = mini.get("datagrid");
   // var resultOtrList = JSON.parse('[${role}]')[0] || [];

    $(function () {
        getHospitals();
    });

    function getHospitals(){
        var regarea= mini.get("regarea").getValue();
        var url="../dicHospitalInfo/getHospitalsByAreaCode?areaCode="+regarea;
        mini.get("regorg").setUrl(url);
    }

    $(function(){
        if($("#flag").val()==1){
            $("#cancer1").prop("checked",true);
        }
    });

    function radios(th){
        $(th).prop("checked",true);
        if($(th).val()==1){
            $("#cancer2").prop("checked",false);
            $("#cancer3").prop("checked",false);
            $("#cancer4").prop("checked",false);
            $("#cancer5").prop("checked",false);
        }else if($(th).val()==2){
            $("#cancer1").prop("checked",false);
            $("#cancer3").prop("checked",false);
            $("#cancer4").prop("checked",false);
            $("#cancer5").prop("checked",false);
        }else if($(th).val()==3){
            $("#cancer2").prop("checked",false);
            $("#cancer1").prop("checked",false);
            $("#cancer4").prop("checked",false);
            $("#cancer5").prop("checked",false);
        }else if($(th).val()==4){
            $("#cancer2").prop("checked",false);
            $("#cancer3").prop("checked",false);
            $("#cancer1").prop("checked",false);
            $("#cancer5").prop("checked",false);
        }else if($(th).val()==5){
            $("#cancer2").prop("checked",false);
            $("#cancer3").prop("checked",false);
            $("#cancer1").prop("checked",false);
            $("#cancer4").prop("checked",false);
        }
    }

    function onSearch() {
        var data={};
        data.regorg=mini.get("regorg").getValue();
        data.csrqStart=mini.get("csrqStart").getValue();
        if(!data.csrqStart) data.csrqStart=stringToDate('1970-01');
        data.csrqEnd=mini.get("csrqEnd").getValue();
        if(!data.csrqEnd) data.csrqEnd=stringToDate(format(getNow(), 'yyyy-MM'));
        if($("#cancer1").is(':checked')){
            data.summary=$("#cancer1").val();
            grid.showColumn("crcCheckNum");grid.showColumn("crcLesionNum");grid.hideColumn("lucCheckNum"); grid.hideColumn("scCheckNum");
            grid.showColumn("crcCheckRate"); grid.showColumn("crcLesionRate");grid.hideColumn("lucCheckRate");grid.hideColumn("scCheckRate");
            grid.showColumn("crcCaseNum");grid.hideColumn("lucCaseNum");grid.hideColumn("scCaseNum");grid.hideColumn("licCaseNum");
            grid.hideColumn("confirmeNum");grid.hideColumn("confirmeRate");grid.hideColumn("confirmeCancerNum");
        }
        if($("#cancer2").is(':checked')){
            data.summary=$("#cancer2").val();
            grid.hideColumn("crcCheckNum");grid.hideColumn("crcLesionNum");grid.showColumn("lucCheckNum"); grid.hideColumn("scCheckNum");
            grid.hideColumn("crcCheckRate"); grid.hideColumn("crcLesionRate");grid.showColumn("lucCheckRate");grid.hideColumn("scCheckRate");
            grid.hideColumn("crcCaseNum");grid.showColumn("lucCaseNum");grid.hideColumn("scCaseNum");grid.hideColumn("licCaseNum");
            grid.hideColumn("confirmeNum");grid.hideColumn("confirmeRate");grid.hideColumn("confirmeCancerNum");
        }
        if($("#cancer3").is(':checked')){
            data.summary=$("#cancer3").val();
            grid.hideColumn("crcCheckNum");grid.hideColumn("crcLesionNum");grid.hideColumn("lucCheckNum"); grid.showColumn("scCheckNum");
            grid.hideColumn("crcCheckRate"); grid.hideColumn("crcLesionRate");grid.hideColumn("lucCheckRate");grid.showColumn("scCheckRate");
            grid.hideColumn("crcCaseNum");grid.hideColumn("lucCaseNum");grid.showColumn("scCaseNum");grid.hideColumn("licCaseNum");
            grid.hideColumn("confirmeNum");grid.hideColumn("confirmeRate");grid.hideColumn("confirmeCancerNum");
        }
        if($("#cancer4").is(':checked')){
            data.summary=$("#cancer4").val();
            grid.hideColumn("crcCheckNum");grid.hideColumn("crcLesionNum");grid.hideColumn("lucCheckNum"); grid.hideColumn("scCheckNum");
            grid.hideColumn("crcCheckRate"); grid.hideColumn("crcLesionRate");grid.hideColumn("lucCheckRate");grid.hideColumn("scCheckRate");
            grid.hideColumn("crcCaseNum");grid.hideColumn("lucCaseNum");grid.hideColumn("scCaseNum");grid.showColumn("licCaseNum");
            grid.hideColumn("confirmeNum");grid.hideColumn("confirmeRate");grid.hideColumn("confirmeCancerNum");
        }
        if($("#cancer5").is(':checked')){
            data.summary=$("#cancer5").val();
            grid.hideColumn("crcCheckNum");grid.hideColumn("crcLesionNum");grid.hideColumn("lucCheckNum"); grid.hideColumn("scCheckNum");
            grid.hideColumn("crcCheckRate"); grid.hideColumn("crcLesionRate");grid.hideColumn("lucCheckRate");grid.hideColumn("scCheckRate");
            grid.hideColumn("crcCaseNum");grid.hideColumn("lucCaseNum");grid.hideColumn("scCaseNum");grid.hideColumn("licCaseNum");
            grid.showColumn("confirmeNum");grid.showColumn("confirmeRate");grid.showColumn("confirmeCancerNum");
        }
        if(!data.summary) data.summary="1";
        grid.load(data, gridLoadSuccess, gridLoadError);
    }

    $(document).ready(function(){
        $("#search").click(function(){
            $("#datagrid").show();
        });
    });

    function getNow() {
        var myDate = new Date();//获取系统当前时间
        var y = myDate.getFullYear();
        var m = myDate.getMonth();
        return y+"-"+m;
    }

    function stringToDate (dateStr,separator){
        if(!separator){
            separator="-";
        }
        var dateArr = dateStr.split(separator);
        var year = parseInt(dateArr[0]);
        var month;
        //处理月份为04这样的情况
        if(dateArr[1].indexOf("0") == 0){
            month = parseInt(dateArr[1].substring(1));
        }else{
            month = parseInt(dateArr[1]);
        }
        var date = new Date(year,month);
        return date;
    }

    function getResetNow() {
        var myDate = new Date();//获取系统当前时间
        var y = myDate.getFullYear();
        var m = myDate.getMonth()+1;
        return y+"-"+m;
    }

    function reset(){
        mini.get("regorg").setValue("");
        var time = new Date();
        var start = time.getFullYear()+"-01";
        mini.get('csrqStart').setValue(start);
        mini.get('csrqEnd').setValue(getResetNow());
        $("#cancer1").prop("checked",true);
        $("#cancer2").prop("checked",false);
        $("#cancer3").prop("checked",false);
        $("#cancer4").prop("checked",false);
        var role = mini.get("role").getValue();
        if(role == 'bsq'){
            var orgCode = mini.get("orgCode").getValue();
            mini.get('regorg').setValue(orgCode);
        }else{
            mini.get('regorg').setValue('');
        }
        grid.clearRows();
    }

    /**
     * miniui 小提示
     * @param msg  消息
     * @param state  消息类型  default|success|info|warning|danger
     */
    function showActionMessage(state, message) {
        mini.showTips({
            content: message,
            state: state,
            x: "Center",
            y: "Center",
            timeout: 2000
        });
    }

    //导出
    function exportData(){
        var data = mini.get("datagrid");
        if (data.data.length==0){
            showActionMessage('info','没有可以导出的数据');
            return;
        }
        var  regorg=mini.get("regorg").getValue();
        var csrqStart= mini.formatDate(mini.get("#csrqStart").getValue(),"yyyy-MM-dd HH:MM:SS");
        var csrqEnd= mini.formatDate(mini.get("#csrqEnd").getValue(),"yyyy-MM-dd HH:MM:SS");
        var pageIndex= mini.get("datagrid").getPageIndex();
        var pageSize= mini.get("datagrid").getPageSize();
        var summary;
        if($("#cancer1").is(':checked')) {
            summary = $("#cancer1").val();
        }else if($("#cancer2").is(':checked')) {
            summary = $("#cancer2").val();
        }else if($("#cancer3").is(':checked')) {
            summary = $("#cancer3").val();
        }else if($("#cancer4").is(':checked')) {
            summary = $("#cancer4").val();
        }else if($("#cancer5").is(':checked')) {
            summary = $("#cancer5").val();
        }

        var param ='?';
        param += '&regorg='+regorg;
        param += '&csrqStart='+csrqStart;
        param += '&csrqEnd='+csrqEnd;
        param += '&pageIndex='+pageIndex;
        param += '&pageSize='+pageSize;
        param += '&summary='+summary;
        window.location.href="../statistics/exportAreaControlData"+param;
    }

</script>

    </div>
</div>

</body>
</html>