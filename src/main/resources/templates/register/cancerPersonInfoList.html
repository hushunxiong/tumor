<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html"
      xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head th:fragment="head(title,links,scripts)">
    <meta charset="UTF-8">
    <!--<title th:replace="${title}">肿瘤早发现</title>-->
    <script src="../static/js/jquery.min.js" th:src="@{/js/jquery.min.js}" type="text/javascript"></script>
    <script src="../static/js/common.js" th:src="@{/js/common.js}" type="text/javascript"></script>


    <script src="../static/lib/miniui/miniui.js" th:src="@{/lib/miniui/miniui.js}" type="text/javascript"></script>
    <script src="../static/lib/miniui/vtype.js" th:src="@{/lib/miniui/vtype.js}" type="text/javascript"></script>
    <link href="../static/lib/miniui/themes/icons.css" th:href="@{/lib/miniui/themes/icons.css}" rel="stylesheet" type="text/css" />
    <link href="../static/lib/miniui/themes/default/miniui.css" th:href="@{/lib/miniui/themes/default/miniui.css}" rel="stylesheet" type="text/css" />

    <link href="../static/css/style.css" th:href="@{/css/style.css}" rel="stylesheet" type="text/css" />
    <link href="../static/css/my-mini.css" th:href="@{/css/my-mini.css}" rel="stylesheet" type="text/css" />

    <!--[if lt IE 9]>
    <script src="../js/html5shiv.min.js" th:src="@{/js/html5shiv.min.js}"></script>
    <script src="../js/respond.js" th:src="@{/js/respond.js}"></script>
    <![endif]-->
    <!--[if lte IE 11]>
    <script type="text/javascript" src="../static/js/flexie.js" th:src="@{/js/flexie.js}"></script>
    <script type="text/javascript" src="../static/js/selectivizr.js" th:src="@{/js/selectivizr.js}"></script>
    <script type="text/javascript" src="../static/js/PIE_IE678.js" th:src="@{/js/PIE_IE678.js}"></script>
    <![endif]-->
    <script type="text/javascript" src="../static/js/messenger.js" th:src="@{/js/messenger.js}"></script>
    <script type="text/javascript" src="../static/lib/lodop/LodopFuncs.js" th:src="@{/lib/lodop/LodopFuncs.js}"></script>
    <link href="../lib/font-awesome/css/font-awesome.min.css" th:href="@{/lib/font-awesome/css/font-awesome.min.css}" rel="stylesheet" type="text/css" />

 <!--   <th:block th:replace="${links}" />
    <th:block th:replace="${scripts}" />-->
</head>
<body>
<div class="content pd-10" style="width:auto; overflow: hidden;">
    <div class="mini-tabs" activeIndex="0" style=" width:100%; overflow: hidden;">
        <div title="初筛一览">
            <!--/*@thymesVar id="#dic" type="com.wonders.health.tumor.common.tags.DictData"*/-->
            <!--/*@thymesVar id="#auth" type="com.wonders.health.tumor.common.tags.AuthData"*/-->
            <div class="search-div-box mb-10">
                <table width="99%" border="0">
                    <tbody>
                    <tr>
                        <td align="left">
                            <div class="keyword">
                                <input id="keyword" name="keyword" class="radius" placeholder="可按照姓名或者证件号码模糊查询" data-tooltip="输入身份证号时至少6位" type="text">
                                <div class="my-btn my-btn-blue" onclick="onSearch()">搜索</div>
                                <div shiro:hasPermission="tumor:cancerPersonInfo:save" class="my-btn my-btn-blue"  onclick="goto('','','3')">新增初筛登记</div>
                            </div>
                        </td>
                        <td width="100px" align="center">
                            <a herf="#" onclick="toggleVisibility(div1)"><strong style="color:#3f93d4">高级搜索&nbsp;<img
                                    th:src="@{/images/pp_up.png}" src="../static/images/pp_up.png" id="pctid"></strong></a></td>
                        <td align="left"></td>
                        <td style="width: 200px" align="right">

                        </td>
                    </tr>
                    </tbody>
                </table>
                <div id="div1" style=" display: none;" class="mt-10">
                    <div class="mini-row">
                        <div class="mini-col-3"><label class="mr-5">ID编号：</label>
                            <input id="id" name="id" type="text" class="mini-textbox" width="63%">
                        </div>
                        <div class="mini-col-3"><label class="mr-5">初筛年份：</label>
                            <select id="csnf" name="csnf" class="select-default radius" style="width:55%">
                                    <option th:each="row,loop : ${csnf}" th:value="${row}" th:text="${row}"  ></option>
                            </select>
                        </div>
                        <div class="mini-col-4">
                            <label class="mr-5">初筛登记日期：</label>

                            <input id="beginDateFrom" name="beginDateFrom" class="mini-datepicker"
                                   value="" allowInput="false" style="width: 30%;" errorMode="border" onvalidation="dateValidation">

                            -
                            <input id="endDateFrom" name="endDateFrom" class="mini-datepicker"
                                   value="" allowInput="false" style="width: 30%;" errorMode="border" onvalidation="dateValidation">
                        </div>
                    </div>

                    <div class="mini-row">
                        <div class="mini-col-3">
                            <label class="mr-5">登记机构所属区：</label>
                            <input id="regarea" name="regarea" showNullItem="true" class="mini-combobox" width="47%"
                                   th:data="${#auth.getAreas(areaCode)}"
                                   textField="text" valueField="id" onvaluechanged="getHospitals()" th:value="${role =='sjk' ? '':areaCode}"  th:showNullItem="${role =='sjk' ? true:false}"  th:disabled="${role =='sjk' ? false:true}"/>
                        </div>
                        <div class="mini-col-3">
                            <label class="mr-5">登记机构：</label>

                            <input id="regorg" name="regorg"  class="mini-combobox" width="55%"
                                   textField="text" valueField="id" th:value="${role =='bsq' ? #auth.currUser().orgCode:''}"  th:showNullItem="${role =='bsq' ? false:true}" th:disabled="${role =='bsq' ? true:false}" />
                        </div>
                        <div class="mini-col-3">
                            <label class="mr-5">初筛状态：</label>
                            <input class="mini-combobox form-control" id="status" name="status"
                                   emptyText="请选择" textField="name" valueField="code" style="width:50%"
                                   showNullItem="true" th:data="${#dic.generals('60003')}" />
                        </div>

                    </div>
                    <div class="mini-row" th:if="${crcFlag==1?true:false}">
                        <div class="mini-col-12" >
                            <div class="mini-col-3" >
                                <label class="mr-5">大肠癌危险评估结果：</label>
                                <input id="crcAssessmentResult" name="crcAssessmentResult" showNullItem="true" class="mini-combobox" width="38%"
                                       emptyText="请选择" textField="name" valueField="code"  th:data="${#dic.generals('60001')}"/>
                            </div>
                            <div class="mini-col-3" >
                                <label class="mr-5">第一次便隐血结果：</label>

                                <input id="firstFobtResult" name="firstFobtResult" showNullItem="true" class="mini-combobox" width="38%"
                                       emptyText="请选择" textField="name" valueField="code"  th:data="${#dic.generals('60001')}"/>
                            </div>
                            <div class="mini-col-3" >
                                <label class="mr-5">第二次便隐血结果：</label>

                                <input id="secondFobtResult" name="secondFobtResult" showNullItem="true" class="mini-combobox" width="33%"
                                       emptyText="请选择" textField="name" valueField="code"  th:data="${#dic.generals('60001')}"/>
                            </div>
                            <div class="mini-col-3" >
                                <label class="mr-5">便隐血检查结果：</label>
                                <input id="fobtResult" name="fobtResult" showNullItem="true" class="mini-combobox" width="35%"
                                       emptyText="请选择" textField="name" valueField="code"  th:data="${#dic.generals('60001')}"/>
                            </div>
                        </div>
                    </div>

                    <div class="mini-row">
                        <div class="mini-col-3"th:if="${crcFlag==1?true:false}">
                             <label class="mr-5">大肠癌判定结果：</label>
                            <input id="crcResult" name="crcResult"  showNullItem="true" class="mini-combobox" width="46%"
                                   emptyText="请选择" textField="name" valueField="code"  th:data="${#dic.generals('60001')}"/>
                        </div>
                        <div class="mini-col-3" th:if="${scFlag==1?true:false}">
                            <label class="mr-5">胃癌判定结果：</label>
                            <input id="scResult" name="scResult" showNullItem="true" class="mini-combobox" width="47%"
                                   emptyText="请选择" textField="name" valueField="code"  th:data="${#dic.generals('60001')}"/>
                        </div>
                        <div class="mini-col-3" th:if="${lucFlag==1?true:false}">
                            <label class="mr-5">肺癌判定结果：</label>
                            <input id="lucResult" name="lucResult" showNullItem="true" class="mini-combobox" width="42%"
                                   emptyText="请选择" textField="name" valueField="code"  th:data="${#dic.generals('60001')}"/>
                        </div>
                        <div class="mini-col-3" th:if="${licFlag==1?true:false}">
                            <label class="mr-5">肝癌判定结果：</label>
                            <input id="licResult" name="licResult" showNullItem="true" class="mini-combobox" width="39%"
                                   emptyText="请选择" textField="name" valueField="code"  th:data="${#dic.generals('60001')}"/>
                        </div>
                    </div>

                    <div class="mini-row" th:if="${licFlag==1?true:false}">
                        <div class="mini-col-3" >
                            <label class="mr-5">肝癌危险评估结果：</label>
                            <input id="licAssessmentResult" name="licAssessmentResult" showNullItem="true" class="mini-combobox" width="42%"
                                   emptyText="请选择" textField="name" valueField="code"  th:data="${#dic.generals('60001')}"/>
                        </div>
                        <div class="mini-col-3" >
                            <label class="mr-5">肝癌辅助检查结果：</label>

                            <input id="licAssistResult"  name="licAssistResult" showNullItem="true" class="mini-combobox" width="38%"
                                   emptyText="请选择" textField="name" valueField="code"  th:data="${#dic.generals('60001')}"/>
                        </div>
                    </div>
                    <div class="mini-row" >
                        <div class="mini-col-4">
                            <!--初筛管理一览 删除权限  -->
                            <input  name="hideInput" shiro:hasPermission="tumor:cancerPersonInfo:del" value="1" class="mini-hidden"/>
                            <!--初筛管理一览 编辑权限  -->
                            <input  name="hideInput" shiro:hasPermission="tumor:cancerPersonInfo:edit" value="2" class="mini-hidden"/>
                        </div>
                    </div>
                </div>
            </div>

            <div id="datagrid" url="../cancerPersonInfo/data" class="mini-datagrid" style=" overflow: auto;width: calc(100vw - 25px);height: auto"
                 sizeList="[10,20,50]" pageSize="20" idField="id">
                <div property="columns" >
                    <div field="name"  width="100px" headerAlign="center" style="min-width:100px; width:auto;" align="center">姓名</div>
                    <div field="personcard" sortField="personcard" renderer="sfzhRenderer" width="100px" headerAlign="center" align="center" allowSort="false">证件号码</div>
                    <div field="gender" type="comboboxcolumn" autoShowPopup="true" width="50px" headerAlign="center" align="center" allowSort="false">性别
                        <input property="editor" class="mini-combobox" style="width:100%;" textField="name"
                               valueField="code" th:data="${#dic.generals('60023')}"/></div>
                    <div field="idNumber" autoShowPopup="true"  width="100px"  headerAlign="center" align="center"  allowSort="false" th:if="${crcFlag==1?true:false}">大肠癌初筛ID</div>
                    <div field="crcAssessmentResult" type="comboboxcolumn" autoShowPopup="true" width="150px" headerAlign="center" align="center" allowSort="false" th:if="${crcFlag==1?true:false}">大肠癌危险评估结果
                        <input property="editor" class="mini-combobox" style="width:100%;" textField="name"
                               valueField="code" th:data="${#dic.generals('60001')}"/></div>
                    <div field="firstFobtResult" type="comboboxcolumn" autoShowPopup="true"  width="150px" headerAlign="center" align="center"  allowSort="false" th:if="${crcFlag==1?true:false}">第一次便隐血检查结果
                        <input property="editor" class="mini-combobox" style="width:100%;" textField="name"
                               valueField="code" th:data="${#dic.generals('60001')}"/></div>
                    <div field="secondFobtResult" type="comboboxcolumn" autoShowPopup="true" width="150px" headerAlign="center" align="center"  allowSort="false" th:if="${crcFlag==1?true:false}">第二次便隐血检查结果
                        <input property="editor" class="mini-combobox" style="width:100%;" textField="name"
                               valueField="code" th:data="${#dic.generals('60001')}"/></div>
                    <div field="fobtResult" type="comboboxcolumn" autoShowPopup="true" width="150px" headerAlign="center" align="center"  allowSort="false" th:if="${crcFlag==1?true:false}">便隐血检查结果
                        <input property="editor" class="mini-combobox" style="width:100%;" textField="name"
                               valueField="code" th:data="${#dic.generals('60001')}"/></div>
                    <div field="crcResult" type="comboboxcolumn" autoShowPopup="true"  width="150px" headerAlign="center" align="center"  allowSort="false" th:if="${crcFlag==1?true:false}">大肠癌判定结果
                        <input property="editor" class="mini-combobox" style="width:100%;" textField="name"
                               valueField="code" th:data="${#dic.generals('60001')}"/></div>
                    <div field="licAssessmentResult" type="comboboxcolumn" autoShowPopup="true" width="150px" headerAlign="center" align="center" allowSort="false" th:if="${licFlag==1?true:false}">肝癌危险评估结果
                        <input property="editor" class="mini-combobox" style="width:100%;" textField="name"
                               valueField="code" th:data="${#dic.generals('60001')}"/></div>
                    <div field="licAssistResult" type="comboboxcolumn" autoShowPopup="true"  width="150px" headerAlign="center" align="center" allowSort="false" th:if="${licFlag==1?true:false}">肝癌初筛辅助检查结果
                        <input property="editor" class="mini-combobox" style="width:100%;" textField="name"
                               valueField="code" th:data="${#dic.generals('60001')}"/></div>
                    <div field="licResult" type="comboboxcolumn" autoShowPopup="true" width="150px" headerAlign="center" align="center" allowSort="false" th:if="${licFlag==1?true:false}">肝癌判定结果
                        <input property="editor" class="mini-combobox" style="width:100%;" textField="name"
                               valueField="code" th:data="${#dic.generals('60001')}"/></div>
                    <div field="scResult" type="comboboxcolumn" autoShowPopup="true" width="150px" headerAlign="center" align="center"  allowSort="false" th:if="${scFlag==1?true:false}">胃癌判定结果
                        <input property="editor" class="mini-combobox" style="width:100%;" textField="name"
                               valueField="code" th:data="${#dic.generals('60001')}"/></div>
                    <div field="lucResult" type="comboboxcolumn" autoShowPopup="true" width="150px" headerAlign="center" align="center" allowSort="false" th:if="${lucFlag==1?true:false}">肺癌判定结果
                        <input property="editor" class="mini-combobox" style="width:100%;" textField="name"
                               valueField="code" th:data="${#dic.generals('60001')}"/></div>
                    <div type="action" renderer="actionRenderer" style="width:100%;"  width="150px" headerAlign="center" align="center" allowSort="false">操作</div>
                </div>
            </div>

        </div>

    </div>
    <input id="manageId" class="mini-hidden"/>
</div>

<!-- 预约小窗口 -->
<div id="yy-window" class="mini-window" title="预约" style="width:1000px; height:700px;" showModal="true" allowResize="false" allowDrag="false">
    <iframe width="980" height="620" id="frame1"></iframe>
</div>
</body>
<script type="text/javascript" th:inline="javascript">
    mini.parse();
    //var messenger = new Messenger('parent', 'tumor');
    var messenger = new Messenger('parent', 'tcm');
    var iframe  = document.getElementById('frame1');
    //messenger.addTarget(iframe.contentWindow, 'addYy');
    messenger.addTarget(iframe.contentWindow, 'addTcm');

    messenger.listen(function (msg) {
        var tbs=JSON.parse(msg);
        if(tbs.ok==true){
            //tbs.bookId
            //tbs.bookDate
            //tbs.bookTime
            var checkCode = "B20190706001";
            var checkDate = "2019-07-20";
            var checkTime = "11:00";
            var manageId = mini.get("manageId").getValue();
            insertCheckRecord(manageId,checkCode,checkDate,checkTime);
            onSearch();
        }
        mini.get("yy-window").hide();
    });

    var grid = mini.get("datagrid");
    var form = new mini.Form('#div1');

    /**
     * 判断是否有权限
     * @type {string}
     */
    var hideValue="";

    $(function () {
        onSearch();
       getHospitals();
        //获取权限标识 1--删除；2--编辑
        var els = mini.getsByName("hideInput");
        for (var i = 0; i < els.length; i++) {
            var el = els[i];
            hideValue +=el.value;
            hideValue +=",";
        }

    });

    var ctxStatic ='..';
    function toggleVisibility(div1) {

        if (div1.style.display == 'none'){
            div1.style.display = 'block';
            document.getElementById("pctid").src =ctxStatic+ '/images/pp_down.png';
        } else if (div1.style.display == 'block') {
            div1.style.display = 'none';
            document.getElementById("pctid").src = ctxStatic+'/images/pp_up.png';
        } else {
            div1.style.display = 'block';
            document.getElementById("pctid").src = ctxStatic+'/images/pp_down.png';
        }

    }


    //操作列
    function actionRenderer(e) {
        var r = e.record;
        var h = '';
        if(r.crc+r.luc+r.lic+r.sc>=1){
            h += '<a onclick="goto(\'' + r.id+ '\',\'' + r.csnf+ '\',\'' + '1'+ '\')" style="color:blue;cursor:pointer">查看</a>&nbsp;';
            if (hideValue.indexOf('2')!=-1){
                h += '<a onclick="goto(\'' + r.id + '\',\'' + r.csnf+ '\',\'' + '2'+ '\')" style="color:blue;cursor:pointer">编辑</a>&nbsp;';
            }
            //存在删除权限
            if (hideValue.indexOf('1')!=-1){
                if(r.delRecordsFlag>1){
                    h += '<a  onclick="deleteRecords(\'' + r.id + '\',\'' + r.csnf+ '\')" style="color:blue;cursor:pointer">删除</a>&nbsp;';
                }else{
                    h += '<a  onclick="deleteRecord(\'' +r.id + '\',\''+ r.csnf + '\',\''+ r.crcCheckId +'\',\''+ r.lucCheckId +'\',\''+ r.licCheckId +'\',\''+ r.scCheckId +'\')" style="color:blue;cursor:pointer">删除</a>&nbsp;';
                }
            }

            if (r.luc == "1" && r.patid != null && r.patid != ""  && r.ldctId == null) {
                var phone = r.mobile;
                if (phone == null || phone == "") {
                    phone = r.telephone;
                }
                h += '<a onclick="lctView(\'' + r.id + '\',\'' + r.patid + '\',\'' + r.blh+ '\',\'' + r.name+ '\',\'' + r.gender+ '\',\'' + ages(getBirthDayAndSex(r.personcard).birthday)+ '\',\'' + r.paymentNo+ '\',\'' + phone + '\',\'' + r.personcard + '\',\'' + getBirthDayAndSex(r.personcard).birthday+ '\')" style="color:blue;cursor:pointer">预约LDCT</a>&nbsp;';
            }
            if (r.ldctId != null && r.ldctId != "") {
                h += '<a onclick="printReserve(\'' + r.id + '\',\'' + r.checkCode + '\')" style="color:blue;cursor:pointer">打印预约单</a>';
                //h += '<a onclick="cancelReserve(\'' + r.patid + '\',\'' + r.checkCode + '\')" style="color:blue;cursor:pointer">取消预约</a>';
            }
        }
        return h;
    }


    function goto(id,csnf,operation) {
        if(id==null||id==''||id==undefined){
            csnf=$("#csnf").val();
        }
        var url = "../screening/form/?manageId="+id+"&checkYear="+csnf+"&operation="+operation;
        mini.mask({
            el: document.body,
            cls: 'mini-mask-loading',
            html: '加载中...'
        });
        window.location.href =url;
    }



    function onSearch() {
        var data = form.getData(true);
        var keyword = $("#keyword").val();
        if (!validateKey(keyword)) {
            return;
        }
        data.keyword=keyword;
        data.csnf= $("#csnf").val();
        grid.load(data, gridLoadSuccess, gridLoadError);
    }


    function validateKey(key) {
        if(key != null && key != undefined && key != '' && key.length < 6){
            var flag = false;
            for(var i = 0 ; i < key.length ; i++){
                var c = key[i];
                if(!((c >= '0' && c <= '9') || c == "x" || c == "X" || c == " ")){
                    flag = true;
                    break;
                }
            }
            if(!flag) {
                mini.showTips({content: "按照证件号码查询，输入不能小于六位", state: "success", x: "center", y: "center", timeout: "2000"});
            }
            return flag;
        }
        return true;
    }

    function getHospitals(){
        var regarea= mini.get("regarea").getValue();
        var url="../dicHospitalInfo/getHospitalsByAreaCode?areaCode="+regarea;
        mini.get("regorg").setUrl(url);
    }

    function deleteRecords(id,csnf) {
        mini.open({
            url:'/tumor/cancerPersonInfo/form?&id='+id+'&csnf='+csnf,
            showMaxButton: false,
            title: "初筛登记信息删除",
            height:150,
            width: 400,
            showCloseButton: true,
            showModal: true,
            ondestroy: function (action) {  //弹出页面关闭前
                //如果点击“确定”
                if (action == "save"){
                    var iframe = this.getIFrameEl();
                    //获取选中、编辑的结果
                    var data = iframe.contentWindow.getData();
                    data = mini.clone(data);
                    if (data!=null){
                        del(data);
                    }
                }
            }
        });
    }


    function deleteRecord(id,csnf,crcCheckId,lucCheckId,licCheckId,scCheckId) {
        var data={};
        data.id=id;
        data.csnf=csnf;
        data.crcCheckId=crcCheckId;
        data.lucCheckId=lucCheckId;
        data.licCheckId=licCheckId;
        data.scCheckId=scCheckId;
        data.historyDelflag=0;
        del(data);
    }


    function del(data) {
        mini.confirm("确认是否删除", "确定？",
            function (action) {
                if (action == "ok") {
                    $.ajax({
                        url: "../cancerPersonInfo/delRecords",
                        data: data,
                        dataType: "json",
                        success: function (res) {
                            if (res.ok) {
                                mini.showTips({
                                    content: res.msg,
                                    state: "success",
                                    x: "center",
                                    y: "center",
                                    timeout: 2000
                                });
                                onSearch();
                            } else {
                                mini.showTips({
                                    content: res.msg,
                                    state: "warning",
                                    x: "center",
                                    y: "center",
                                    timeout: 2000
                                });
                            }
                        }
                    });
                }
            }
        );
    }

    //打开预约LDCT画面
    function lctView(id,patid,blh,name,sex,age,cardNo,phone,sfzh,birth) {
        var ip = [[${ip}]];
        var orgCode = [[${orgCode}]];
        ip = ip.substring(0, ip.lastIndexOf(":"));
        var obj = {};
        obj.patid = patid;
        obj.blh = blh;
        obj.name = encodeURIComponent(encodeURIComponent(name));
        obj.sex = sex;
        obj.age = age;
        obj.ageUnit = "岁";
        obj.cardNo = cardNo;
        obj.phone = phone;
        obj.sfzh = sfzh;
        obj.birth = birth;
        obj.communityCode = orgCode;

        mini.get("manageId").setValue(id);

        /*******ip = "http://192.168.30.117";******/
        //var url = ip + ':8071/xkyy/queryYyks.action?patid='+patid+'&blh='+blh+"&name="+encodeURIComponent(encodeURIComponent(name));
        //url += "&sex="+sex+"&age="+age+"&cardNo="+cardNo+"&phone="+phone+"&sfzh="+sfzh+"&birth="+birth;
        //var url = ip + ':8071/xkyy/queryYyks.action?param='+JSON.stringify(obj);
        var url = "http://10.1.93.110/tcm/api/addTbs?age=65";

        $("#frame1").attr("src", url);
        mini.get("yy-window").show();
    }

    //插入预约表
    function insertCheckRecord(manageId,checkCode,checkDate,checkTime) {
        $.ajax({
            url : "../cancerPersonInfo/insertAppCheck",
            data:{manageId:manageId, checkCode:checkCode, checkDate:checkDate, checkTime:checkTime},
            dataType: "json",
            success : function(res) {
                if (res.ok) {
                    mini.showTips({
                        content: res.msg,
                        state: "success",
                        x: "center",
                        y: "center",
                        timeout: 2000
                    });
                    onSearch();
                } else {
                    mini.showTips({
                        content: res.msg,
                        state: "warning",
                        x: "center",
                        y: "center",
                        timeout: 2000
                    });
                }
            }
        });
    }

    //打印预约单
    function printReserve(id,checkCode) {
        var LODOP = getLodop();
        LODOP.PRINT_INIT("打印预约检查单");
        LODOP.SET_SHOW_MODE ("PREVIEW_IN_BROWSE","2");
        LODOP.SET_PRINT_PAGESIZE(1,"0","0","A4");  //设置打印页面属性：2：表示横向打印，0：定义纸张宽度，为0表示无效设置，A4：设置纸张为A4

        LODOP.ADD_PRINT_HTM("5","10","98%","100%",getPrintHtml(id)); //添加html元素 top; left; width; height
        LODOP.ADD_PRINT_BARCODE(10,600,200,30,"code39",checkCode);
        LODOP.PREVIEW();
    }

    //取消预约
    function cancelReserve(patid, checkCode) {
        $.ajax({
            url : "../cancerPersonInfo/cancelReserve",
            data:{patid:patid, checkCode:checkCode},
            dataType: "json",
            success : function(res) {
                if (res.ok) {
                    mini.showTips({
                        content: res.msg,
                        state: "success",
                        x: "center",
                        y: "center",
                        timeout: 2000
                    });
                    onSearch();
                } else {
                    mini.showTips({
                        content: res.msg,
                        state: "warning",
                        x: "center",
                        y: "center",
                        timeout: 2000
                    });
                }
            }
        });
    }

    //获取打印页面-预约检查单
    function getPrintHtml(id) {
        var obj;
        var url ='../cancerPersonInfo/printReserve?id='+id;
        $.ajax({
            url : url,
            type : "get",
            async : false,
            success : function(data) {
                obj = data;
            }
        });
        return obj;
    }
</script>

</html>

